<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Worksy Micro Tester</title>
    <style>
      body {
        font-family: system-ui, Inter, Arial;
        margin: 24px;
        max-width: 760px;
      }
      input,
      button {
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
      }
      pre {
        background: #111;
        color: #eee;
        padding: 12px;
        border-radius: 8px;
        overflow: auto;
        min-height: 120px;
      }
      .row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin: 8px 0;
      }
    </style>
  </head>
  <body>
    <h1>Worksy Micro Tester</h1>

    <div class="row">
      <button id="ping">Ping</button>
      <button id="seed">Seed demo assignment</button>
    </div>

    <div class="row">
      <input id="student" placeholder="Student (e.g. Rahul)" />
      <input id="aid" style="min-width: 360px" placeholder="Assignment UUID" />
      <button id="load">Load policy & caps</button>
    </div>

    <div class="row">
      <input
        id="msg"
        style="min-width: 480px"
        placeholder="Type a question..."
      />
      <button id="send">Send</button>
    </div>

    <h3>Result</h3>
    <pre id="out">(nothing yet)</pre>

    <script>
      const out = document.getElementById("out");
      const log = (x) =>
        (out.textContent =
          typeof x === "string" ? x : JSON.stringify(x, null, 2));

      document.getElementById("ping").onclick = async () => {
        const r = await fetch("/api/ping");
        log(await r.json());
      };

      document.getElementById("seed").onclick = async () => {
        const r = await fetch("/api/assignment/seed", { method: "POST" });
        const j = await r.json();
        log(j);
        if (j.id) document.getElementById("aid").value = j.id;
      };

      document.getElementById("load").onclick = async () => {
        const id = document.getElementById("aid").value.trim();
        if (!id) return log("Paste an assignment id first.");
        const r = await fetch(
          "/api/policy?assignmentId=" + encodeURIComponent(id),
        );
        log(await r.json());
      };

      let sessionId = null;
      document.getElementById("send").onclick = async () => {
        const student = document.getElementById("student").value.trim();
        const id = document.getElementById("aid").value.trim();
        const msg = document.getElementById("msg").value.trim();
        if (!student || !id || !msg)
          return log("Fill student, assignment id, and message.");
        const r = await fetch("/api/chat", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({
            sessionId,
            assignmentId: id,
            studentRef: student,
            message: msg,
          }),
        });
        const j = await r.json();
        if (r.ok) sessionId = j.sessionId;
        log(j);
      };
    </script>
  </body>
</html>
